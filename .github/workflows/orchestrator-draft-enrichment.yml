name: Orchestrator - Draft Issue Enrichment

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created, edited]

permissions:
  issues: write
  contents: read

jobs:
  check-draft-and-enrich:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Draft Status
        id: draft_check
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ./scripts/infra/check-draft-status.sh
          ./scripts/infra/check-draft-status.sh

      - name: Spawn Enrichment Agent
        if: steps.draft_check.outputs.is_draft == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Check if enrichment agent already active
          EXISTING_ENRICHMENT=$(gh issue view $ISSUE_NUMBER --json comments --jq '.comments[].body' | grep "ENRICHMENT-AGENT-ACTIVE" || true)

          if [ -n "$EXISTING_ENRICHMENT" ]; then
            echo "Enrichment agent already active on this issue"
            exit 0
          fi

          # Post enrichment agent spawn trigger
          gh issue comment $ISSUE_NUMBER --body \
            "ðŸ¤– **ORCHESTRATOR-SPAWN-ENRICHMENT-AGENT**

            **Issue**: #${ISSUE_NUMBER}
            **Type**: draft-enrichment
            **Status**: ready-for-enrichment
            **Timestamp**: $(date -u +\"%Y-%m-%dT%H:%M:%SZ\")

            ---

            <!-- ENRICHMENT-AGENT-ACTIVE -->

            **Instructions for Enrichment Agent:**

            **Your role is to improve this draft issue to make it ready for implementation by development agents.**

            **Tasks:**
            1. **Analyze** the current issue content using gh issue view
            2. **Identify gaps** - missing requirements, unclear acceptance criteria, missing context
            3. **Update the issue body** using gh issue edit --body - add proper structure with sections: Summary, Requirements, Acceptance Criteria, Technical Notes, etc.
            4. **Ask clarifying questions** - post comments with specific questions if requirements are unclear (optional)
            5. **Remove draft label immediately** using gh issue edit --remove-label draft - enrichment is complete even if questions remain
            6. **Post completion comment** - note that issue is ready for implementation, questions can be answered during development

            **Guidelines:**
            - Keep questions focused and specific
            - Suggest concrete acceptance criteria
            - Identify dependencies on other work
            - Flag potential technical challenges
            - Recommend test scenarios
            - Do not start implementation - only prepare the issue

            **When complete:**
            Enrichment is complete when:
            - Issue body has proper structure (Summary, Requirements, Acceptance Criteria)
            - Acceptance criteria are specific and testable
            - Draft label is removed
            - Issue is ready for implementation (clarifying questions can be answered during development)

            **Format your updates as comments on this issue.**

            ---
            *Orchestrator Draft Enrichment System v1.0*"

      - name: Add Enrichment Label
        if: steps.draft_check.outputs.is_draft == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "enrichment:active" || true

      - name: Notify Draft Removed
        if: |
          steps.draft_check.outputs.is_draft == 'false' &&
          github.event.action == 'unlabeled'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if draft was just removed
          UNLABELED=$(echo '${{ github.event.label.name }}' | grep -i draft || true)

          if [ -n "$UNLABELED" ]; then
            gh issue comment ${{ github.event.issue.number }} --body \
              "âœ… **Draft Status Removed - Enrichment Complete**

              The draft label has been removed. This issue is now ready for implementation workflow.

              **Next Steps:**
              1. Orchestrator will check for clarifying questions
              2. If no questions or all answered, a development agent will be spawned
              3. Agent will follow TDD workflow and create PR

              **Status**: ENRICHMENT COMPLETE â†’ READY FOR IMPLEMENTATION

              ---
              *Orchestrator Event-Driven System v1.0*"

            gh issue edit ${{ github.event.issue.number }} \
              --remove-label "enrichment:active" || true
          fi
